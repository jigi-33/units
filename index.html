<html>
<head>
    <title>Unit testing</title>
    <meta charset="utf-8"/>
</head>
<body>
<!-- Libs -->
<script src="~ws/ws/ext/jquery-full.js" data-pack-name="ws"></script>
<script src="~ws/ws/ext/jquery-cookie-min.js" data-pack-name="ws"></script>

<!-- Mocha setup -->
<link rel="stylesheet" href="node_modules/mocha/mocha.css"/>
<div id="mocha"></div>
<script src="node_modules/mocha/mocha.js"></script>
<script src="node_modules/chai/chai.js"></script>
<script>
    mocha.setup({
        ui: 'bdd',
        reporter: function (runner) {
            var query = typeof window === 'undefined' ? '?reporter=XUnit' : window.location.search,
                    result = query.match(new RegExp("[?&]reporter=([^&]*)&?$")),
                    reporterCode = result ? result[1] : 'HTML';

            if (!(reporterCode in Mocha.reporters)) {
                throw new Error('Reporter "' + reporterCode + '" is undefined.');
            }
            var reporter = new Mocha.reporters[reporterCode](runner, {});

            if (reporterCode == 'XUnit') {
                //Change XUnit output stream
                reporter.buffer = [];
                reporter.domElement = $('<div/>')
                        .attr('id', 'report')
                        .appendTo('body');
                reporter.write = function (line) {
                    this.buffer.push(line);
                    this.domElement.html(this.buffer.join("\n"));
                };
            }
        }
    });

    var assert = chai.assert;
</script>

<!-- WS setup -->
<script>
    window.wsConfig = {
        wsRoot: '~ws/ws/',
        resourceRoot: '~resources/',
        nostyle: true,
        globalConfigSupport: false
    };
</script>
<script src="~resources/WS.Data/contents.js" data-pack-name="contents"></script>
<script src="~ws/ws/ext/requirejs/require.js"></script>
<script src="~ws/ws/ext/requirejs/config.js"></script>
<script src="~ws/ws/lib/core.js"></script>
<script src="~ws/ws/res/js/bootup.js" data-pack-name="ws"></script>

<!-- Run tests -->
<script>
    requirejs.config({
        paths: {
            Squire: 'node_modules/squirejs/src/Squire'
        }
    });

    mocha.checkLeaks();
    
    $ws.core.ready.addCallback(function () {
        requirejs(['~test-list'], function () {
            mocha.run(function () {
                $('body').addClass('tests-finished');
            });
        });
    });
</script>
</body>
</html>